---
title: ASC22-23 回忆录
tags: [Competitions]
date: 2023-01-07
categories: [Network,Ops,AI,Competitions]
---
# ASC 22-23 回忆录

## 写在前面

ASC 22-23 在中国科学技术大学举行，我作为初次参与 ASC 的新人，很幸运的一路来到了决赛现场。

在本届比赛之前，学校并没有一个具体的超算队概念。而是济南超级计算技术研究院和数学与统计学院有深入的合作，从 AIDC 组织遴选了一些有能力的同学来参与相关的的比赛。而我作为 QLU 网络运维（后来单独分离出网络与高性能计算协会）的成员，得到了奇妙熟人关系的推荐和介绍，光速走完流程加入了 AIDC，并相对顺利的被遴选成为有资格参与 ASC22-23 竞赛的队员。

在参加这个比赛之前，我更多的是做一些网络安全和算法相关的东西，外加从 QLU 网络运维那边得到的 Linux Ops 和集群组建运维的能力。可以说我在 HPC 这个领域算是彻底的小白。在确定了 ASC22-23 的参赛资格后，我在短时间内速成了基本的体系结构和 CUDA 编程、MPI、OpenMP，以及部分高端设备的软硬件组建调试能力（A100 和 InfiniBand Switch/HCA）。

在此必须要感谢拉我上车的好哥们儿，例如旭哥、烁哥以及涛哥，也必须要感谢济南超级计算技术研究院/国家超算济南中心为我们提供的强大经费和先进资源（括号大学万岁）。

## 决赛？寄点换的！

ASC 作为一个不受我校重视的野鸡比赛 (?) 我们作为参赛队员，无法得到任何校方行政方案的支持。换句话说，在济南超算那边备赛以及出席决赛现场，是没办法顺利请下假的。我作为一个生物工程专业的学生 (你没看错，但这是另外一个故事)，更无法被学院理解并给予支持。于是我就只能请了一些同学代我签到。这个学期还好死不死的有什么工程实训之类的课程。在课堂测试和期中都摆烂的情况下，我的平时分不出意料的大寄特寄。而我大部分的时间也放到备赛，几乎没有看过课程内容，所以即使比完赛回校突击学习，也没能避免挂科一门、其余课程勉强及格的悲剧。

好在生物工程的课程对于我今后的发展影响不大，我只需要吃一些重修的苦头，拿到毕业证就行了。

## 分工？软硬一把梭！

当时能被拉进队伍，或许只是看中了我 Linux Ops 和集群组建运维的能力。所以我一开始的角色定位是队伍的软硬件维护。我之前更多的是接触一些网络路由交换设备和普通业务服务器，对于 ASC 比赛的硬件配置，不能说是很熟悉，但也不算陌生。在手欠搞断一根 Riser 卡的 PCIe 卡扣后，我彻底玩明白了浪潮 5280M6。最大的感受就是浪潮的工业设计、技术资料、以及软硬件都可以说是一塌糊涂。我三番五次被浪潮搞得心态破防，无时不刻不在想念 DELL 和 HPE，但对于国产服务器来说，确实算勉强凑合，毕竟要求不能太高。

### 浪潮为年幼的我来了一点草台班子震撼

从上手这几台服务器开始，我几乎每天都被浪潮搞得崩溃。

在装系统的时候，我注意到 VGA 显示器总是没有信号输出，或者是键盘无法输入按键，USB 安装盘也时好时坏。这种事情显然是不科学的，我首先选择充分信任看上去 (实际上也) 崭新的硬件，转而从自己身上寻找原因。我更换了新键盘后，U 盘居然不认了；搞来新 U 盘后，显示器居然黑了。

坏了！见鬼了！

我不得不怀疑是接口的问题，于是重新整理线缆，绕到机器后面，把显示器插进了后面版 VGA。突然映出的系统安装界面让我感到视线模糊。

突然，一个大胆的猜想在我心中浮现。我快步跑到前面拔掉键盘 USB 线，然后把后面的 VGA 重新插回前面板，显示器画面还是那么的亮。然后我颤抖着把键盘插进了后面版 USB，按了下回车————安装流程切入了下一页。

我在其余几个节点尝试了上述的操作，居然完美复现。

破案了，浪潮前面板的两个 USB 口和一个 VGA 口由于供电设计，居然不能同时使用！在浪潮用户手册和技术白皮书中，没有任何提及！一瞬间我对整个世界都产生了深深的怀疑，草台班子论在我年幼的心中生根发芽。

在后面的几天，我又被浪潮的 bios bug 坑惨，即使妥善的设置好了启动选项，但一台特定的机器在重启后会随机的自动进入 bios 设置，无法在不干预的情况下进入系统...

我抽出机器的保修卡，SN 号码是九个 9。我沉默着塞了回去。

### 令人心累又兴奋的 MLX

得益于 Mellanox/NVIDIA 完备的资料和网络资源，我很顺利的装好了之前从未摸过的 InfiniBand HPC 全家桶。理论上，只需要用线缆连接到 IB Switch 就可以愉快的感受 MLX 科技了！

成功分清 QSFP56 的正反面后，我很快接好了线缆。淡蓝绿的初音色主动光缆和粗大的 connector 似乎在向我宣示金钱就是性能。

然而在漫长的等待和满怀希望的重启之后，ib ststus 显示端口始终处于 pooling 状态，无法转入期望中的 Active。

为了确认是硬件的问题还是驱动的问题，我 P2P 直连了两个节点上的 HCA，发现成功握手到 200Gbps，尝试了一下跨节点的 MPI 通讯也是可以跑起来的。基本确认是中间的 IB Switch 有问题。最终我到处查找资料和调试，发现是从济南超算备件仓库拉出来的崭新出厂 QM8790 并不认识我们用的 HDR 100Gbps 主动光缆。因为正经的 HDR 是 200G，HDR 100G 的规格是后来才诞生的。所以我们只需要给交换机升级到最新的系统就万事大吉了！

问题就在于，如何给交换机升级系统呢？MLX/NVIDIA 的文档告诉我们，升级系统很简单，只需要在节点侧使用线缆连接交换机，就可以用特定的工具 burn firmware 了。

很好。我看着手中仅有的 100Gbps 主动光缆，回忆了一下我为什么要升级系统。

在仔细端详了 QM8790 充满接口洞洞的机身后，我愣是没研究出还有什么能够 workaround 的方法，因为 QM8790 的确没有什么带外管理的方式。理论上机身上的 I2C MicroUSB 能用来烧录系统，但是找到能用的烧录线比找一根兼容的 IB 线缆还难。

于是我在偌大的超算中心到处借 HDR200 或者向前兼容的线缆，一番努力后，我从算网团队那边借到了一根 EDR 铜缆。我感叹了一下主动光缆真是好文明后，把粗大笨重难以弯折的铜缆接入了 IB Switch。这根铜缆成功握手连接并完成升级交换机系统的重任后，被我送还原有的位置。

### I'm Benchmark Man

后来 HPL 和 HPCG 的任务给了我，在队伍成员没有任何 ASC 经历、也没有任何前辈留下的经验资料的情况下，我只能从 CPU 的 hpl 和 hpcg 开始，写脚本自动跑各种不同的配置参数，得到了最好的参数组合。

而 GPU 上的 HPL 和 HPCG 就难搞了。一开始，我像无头苍蝇一样，找到了远古的 fermi-hpl，经过了各种修补，在 A100 上成功的跑了起来。但性能远不及理论水平。由于我们都没有经验，我们参考到了 ASC21 决赛现场，中山大学使用与我们相同的四级八卡配置跑出了 79.04TFlops 的 HPL 成绩，并将其作为我们的基线。

我尝试动手魔改 fermi-hpl，迫于速成的 CUDA 编程能力，没有成功取得显著的效果。期间在网上发现了 NVIDIA NGC 中有 HPC-Benchmark 容器，但组件都是闭源的。我受到 ASC 官方 Notification 的误导，以为 hpl 必须是有源码的，就没有深入研究。

在无数次被 fermi-hpl 毒打后，我鼓起勇气写了邮件询问组委会是否允许使用 NVIDIA 提供的闭源二进制，结果他们却说不管！我们还是吃了没有经验的亏。

虽然用起来的过程中也是经历了一些坎坷，但我至少得到了能看的成绩，接下来的问题就是如何在限制 3KW 功耗的情况下取得好成绩。

具体手段还是要保密的，毕竟 HPL/HPCG 是每年的固定赛题，但大概的方向其实就那么几个，就是看细心程度了。

在我无所不用其极的功耗调教和优化手段下，我们成功在四机八卡 3KW 的限制下，跑出了超越去年 The Highest Linpack 的性能记录。我不禁暗暗幻想能否有机会为初次参赛就进入决赛的队伍拿下一个单项奖...